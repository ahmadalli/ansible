---
- name: include oned config variables
  ansible.builtin.include_vars: oned.yaml
- name: update oned configs
  ansible.builtin.template:
    src: oned-{{ opennebula_frontend_version }}.conf.j2
    dest: /etc/one/oned.conf
    mode: '0640'
    owner: root
    group: oneadmin
- name: update sunstone server configs
  ansible.builtin.template:
    src: sunstone-server-{{ opennebula_frontend_version }}.conf.j2
    dest: /etc/one/sunstone-server.conf
    mode: '0640'
    owner: root
    group: oneadmin
- name: include oned kvm override variables
  ansible.builtin.include_vars: vmm_exec_kvm.yaml
- name: update kvm override configs
  ansible.builtin.template:
    src: vmm_exec_kvm-{{ opennebula_frontend_version }}.conf.j2
    dest: /etc/one/vmm_exec/vmm_exec_kvm.conf
    mode: '0640'
    owner: root
    group: oneadmin
- name: clear systemd overrides
  ansible.builtin.file:
    path: "{{ opennebula_frontend_systemd_unit_overrides_directory }}"
    state: absent
- name: create systemd overrides directory
  ansible.builtin.file:
    path: "{{ opennebula_frontend_systemd_unit_overrides_directory }}"
    state: directory
    owner: root
    group: root
    mode: "0644"
- name: configure systemd overrides
  ansible.builtin.copy:
    dest: "{{ opennebula_frontend_systemd_unit_overrides_directory }}/overrides.conf"
    owner: root
    group: root
    mode: "0644"
    content: |
      [Unit]
      After={{ opennebula_frontend_database_systemd_unit }}

      [Service]
      TimeoutSec=3600
- name: start services
  ansible.builtin.systemd:
    name: "{{ item }}"
    daemon_reload: true
    enabled: true
    state: restarted
  loop:
    - opennebula
    - opennebula-sunstone
- name: check if opennebula service is started
  shell: oneuser show
